name: Deploy Harbor Infrastructure
on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: harbor-production-deployment
  cancel-in-progress: false

jobs:
  check-dependencies:
    name: Verify Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dependency:
          - { stack: "egulatee/traefik-ingress/prod", name: "Traefik Ingress" }
          - { stack: "egulatee/kubeconfig/prod", name: "Kubeconfig" }
          - { stack: "egulatee/rook-ceph/dev", name: "Rook-Ceph Storage" }
          - { stack: "egulatee/keycloak/prod", name: "Keycloak Auth" }
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check ${{ matrix.dependency.name }}
        uses: pulumi/actions@v5
        with:
          command: stack output
          stack-name: ${{ matrix.dependency.stack }}
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

  preview-before-deploy:
    name: Preview Changes
    runs-on: ubuntu-latest
    needs: check-dependencies
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure kubectl from kubeconfig stack
        run: |
          mkdir -p $HOME/.kube
          pulumi stack output kubeconfig --stack egulatee/kubeconfig/prod --show-secrets > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Pulumi Preview
        uses: pulumi/actions@v5
        with:
          command: preview
          stack-name: prod
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: preview-before-deploy
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure kubectl from kubeconfig stack
        run: |
          mkdir -p $HOME/.kube
          pulumi stack output kubeconfig --stack egulatee/kubeconfig/prod --show-secrets > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Pulumi Up
        uses: pulumi/actions@v5
        with:
          command: up
          stack-name: prod
          upsert: true
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}

      - name: Verify Harbor Deployment
        run: |
          echo "‚úÖ Harbor Infrastructure deployed successfully"
          echo "üìä Stack Outputs:"
          pulumi stack output --json | python3 -m json.tool
          echo ""
          echo "üîç Verifying Harbor accessibility..."
          timeout 60 bash -c 'until curl -k -s -f https://harbor.egyrllc.com/api/v2.0/health > /dev/null; do echo "Waiting for Harbor..."; sleep 5; done' && echo "‚úÖ Harbor is accessible" || echo "‚ö†Ô∏è Harbor health check timed out (may still be starting)"
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
