# Harbor Infrastructure - Claude Code Project Notes

## CI/CD Requirements

### GitHub Actions Runner Configuration

**IMPORTANT**: This project's CI/CD workflows are designed to work with standard GitHub-hosted runners (`ubuntu-latest`).

**Self-hosted runners are NOT required** for the following reasons:

1. **No External Dependencies**: The project no longer depends on Vault or other cluster-internal services during CI operations. All secrets are managed via Pulumi encrypted config.

2. **Simplified Architecture**: As of PR #19 (implements issue #21), Harbor admin password and database credentials are stored in Pulumi config instead of Vault. This eliminates the need for any runtime Vault access during CI operations.

3. **Isolation & Security**: GitHub-hosted runners provide a clean, isolated environment without requiring infrastructure setup or maintenance.

### Workflow Files

The following workflows are configured to use `ubuntu-latest`:
- `.github/workflows/pull_request.yml` - PR preview workflow
- `.github/workflows/deploy.yml` - Production deployment workflow (all jobs)

### Related Issues

- Issue #19: Refactored Harbor admin password from Vault to Pulumi config (COMPLETED)
- Issue #21: Original proposal for Vault removal (COMPLETED via PR #19)

## Architecture Notes

### Password Management

**Current Implementation** (as of PR #19):
- Harbor admin password and database credentials are stored in **Pulumi encrypted config**
- Secrets are created directly as Kubernetes Secrets by Pulumi during deployment
- External Secrets Operator (ESO) is **no longer used**
- Vault is **no longer a dependency** for this stack

This approach:
- ✅ Works seamlessly with GitHub-hosted runners
- ✅ Maintains security through Pulumi's encryption
- ✅ Simplifies the architecture by removing Vault/ESO dependencies
- ✅ Enables safe CI/CD automation without cluster DNS requirements

### Stack References

This stack depends on:
- `egulatee/kubeconfig/prod` - Kubernetes cluster access
- `egulatee/keycloak/prod` - Keycloak OIDC configuration
- `egulatee/traefik-ingress/prod` - Ingress controller and className
- `egulatee/rook-ceph/dev` - S3 storage backend via RGW

## Development Guidelines

When modifying CI/CD workflows:
- Always use `runs-on: ubuntu-latest` (standard GitHub-hosted runners)
- Do not add dependencies on cluster-internal services that require DNS resolution
- Keep CI operations stateless and external to the cluster
- Store sensitive data in:
  - **Pulumi encrypted config** (preferred for infrastructure secrets like passwords)
  - **GitHub secrets** (for tokens like `PULUMI_ACCESS_TOKEN` and `GITHUB_TOKEN`)
- Never commit unencrypted secrets to the repository

### Secret Management Best Practices

**Pulumi Config Secrets** (current approach):
- Use `pulumi config set --secret <key> <value>` to store encrypted secrets
- Access in code via `config.requireSecret("key")`
- Secrets are encrypted in the state file and only decrypted during Pulumi operations
- Ideal for infrastructure credentials (database passwords, admin passwords, etc.)

**GitHub Secrets**:
- Store tokens required for CI/CD operations (e.g., `PULUMI_ACCESS_TOKEN`)
- Access via `${{ secrets.SECRET_NAME }}` in workflow files
- Ideal for CI/CD tokens and service account credentials
