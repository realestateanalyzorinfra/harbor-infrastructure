# Harbor Infrastructure - Claude Code Project Notes

## CI/CD Requirements

### GitHub Actions Runner Configuration

**IMPORTANT**: This project's CI/CD workflows MUST use standard GitHub-hosted runners (`ubuntu-latest`).

**Do NOT use self-hosted runners** for the following reasons:

1. **Vault Access Limitation**: The current implementation reads the Harbor admin password from Vault during `pulumi preview`. Self-hosted runners would require cluster DNS access to reach the internal Vault service, which creates unnecessary complexity and security concerns.

2. **Future Architecture**: See issue #21 for the planned refactoring to use Pulumi config instead of Vault for the Harbor admin password. Once implemented, this will eliminate the need for any Vault access during CI operations.

3. **Simplicity**: GitHub-hosted runners provide a clean, isolated environment without requiring infrastructure setup or maintenance.

### Workflow Files

The following workflows are configured to use `ubuntu-latest`:
- `.github/workflows/pull_request.yml` - PR preview workflow
- `.github/workflows/deploy.yml` - Production deployment workflow (all 3 jobs)

### Related Issues

- Issue #19: Original CI failure due to Vault DNS resolution with GitHub-hosted runners
- Issue #21: Proposed refactoring to use Pulumi config for Harbor admin password

## Architecture Notes

### Password Management

Currently, the Harbor admin password is stored in Vault and read during Pulumi execution. This creates a dependency on Vault access during CI operations.

**Planned improvement** (Issue #21): Store the password in Pulumi encrypted config instead, eliminating the need for Vault access during CI while maintaining security and allowing ESO to continue syncing to Kubernetes secrets at runtime.

### Stack References

This stack depends on:
- `egulatee/kubeconfig/prod` - Kubernetes cluster access
- `egulatee/hashcorp-vault/prod` - Vault service URL (currently used, will be removed in #21)
- `egulatee/keycloak/prod` - Keycloak OIDC configuration
- `egulatee/traefik-ingress/prod` - Ingress controller and className
- `egulatee/rook-ceph/dev` - S3 storage backend via RGW

## Development Guidelines

When modifying CI/CD workflows:
- Always use `runs-on: ubuntu-latest`
- Do not add dependencies on cluster-internal services that require DNS resolution
- Keep CI operations stateless and external to the cluster
- Ensure sensitive data is stored in GitHub secrets or Pulumi config (encrypted)
